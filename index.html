<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA MASSIMA | Sales Intelligence</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. CORE THEME & VARIABLES
           ========================================= */
        :root {
            /* Palette Casa Massima */
            --bg-body: #0f1012;
            --bg-sidebar: #141414;
            --bg-panel: #1e1e1e;
            --bg-card: #252525;
            --bg-input: #2d2d2d;
            
            --brand-red: #9e2a2b;
            --brand-red-dark: #7a1f20;
            --brand-gold: #d4a373;
            --brand-gold-dim: #b0865c;
            --brand-brown: #5d4037;

            --text-main: #e0e0e0;
            --text-muted: #9ca3af;
            --text-dim: #6b7280;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;

            --border: #333333;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 15px rgba(212, 163, 115, 0.1);
        }

        /* Reset & Scrollbar */
        * { box-sizing: border-box; outline: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand-gold); }

        body { 
            margin: 0; padding: 0; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Open Sans', sans-serif; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* =========================================
           2. SIDEBAR NAVIGATION (FIXED STANDARD)
           ========================================= */
        .sidebar { 
            width: 260px; 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            z-index: 100; 
            flex-shrink: 0; 
            transition: all 0.3s ease;
        }

        .brand-area { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 35px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .brand-logo-circle {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--brand-red), var(--brand-brown));
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            color: var(--brand-gold);
            font-family: 'Montserrat'; font-weight: 700; font-size: 20px;
            box-shadow: 0 0 10px rgba(158, 42, 43, 0.4);
        }

        .brand-text h2 { 
            margin: 0; 
            font-family: 'Montserrat'; 
            font-size: 15px; 
            color: var(--brand-gold); 
            font-weight: 700; 
            letter-spacing: 0.5px; 
        }
        .brand-text span { 
            font-size: 10px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }

        .nav-menu { list-style: none; padding: 0; flex: 1; margin: 0; }
        .nav-item { margin-bottom: 6px; }
        
        .nav-link { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            padding: 12px 16px; 
            border-radius: 8px; 
            color: var(--text-muted); 
            text-decoration: none; 
            transition: 0.2s; 
            font-size: 13px; 
            font-weight: 600; 
        }
        
        .nav-link:hover { 
            background: rgba(255, 255, 255, 0.05); 
            color: var(--text-main); 
        }
        
        /* Active State Configuration */
        .nav-link.active { 
            background: linear-gradient(90deg, rgba(158, 42, 43, 0.2), transparent); 
            color: var(--brand-gold); 
            border-left: 3px solid var(--brand-red); 
        }
        
        .nav-link i { width: 20px; text-align: center; font-size: 14px; }

        .user-panel {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #333;
            border: 2px solid var(--brand-gold);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; color: var(--brand-gold);
        }

        /* =========================================
           3. MAIN LAYOUT & HEADER
           ========================================= */
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
        }

        .top-header {
            height: 70px;
            background: var(--bg-body);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            flex-shrink: 0;
        }

        .page-info h1 {
            font-family: 'Montserrat';
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        .page-info p {
            margin: 4px 0 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-filter {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn {
            padding: 9px 18px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            border: none;
            transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
            font-family: 'Montserrat';
        }
        .btn-primary { background: var(--brand-red); color: white; }
        .btn-primary:hover { background: #b93233; box-shadow: 0 0 12px rgba(158, 42, 43, 0.4); }
        .btn-gold { background: var(--brand-gold); color: #1a1a1a; }
        .btn-gold:hover { background: #e0b484; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--brand-gold); color: var(--brand-gold); }

        /* =========================================
           4. DASHBOARD GRID SYSTEM
           ========================================= */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: auto auto auto;
            gap: 24px;
            margin-bottom: 40px;
        }

        /* KPI CARDS (Top Row) */
        .kpi-card {
            grid-column: span 3;
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); border-color: #444; }
        
        .kpi-icon-bg {
            position: absolute;
            right: -10px; top: -10px;
            font-size: 80px;
            opacity: 0.03;
            color: white;
            transform: rotate(15deg);
        }

        .kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .kpi-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        .kpi-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .bg-success-dim { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .bg-danger-dim { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .kpi-value { font-family: 'Montserrat'; font-size: 28px; font-weight: 700; color: white; margin-bottom: 5px; }
        .kpi-subtext { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 5px; }

        /* CHARTS PANELS */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            display: flex; flex-direction: column;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-family: 'Montserrat'; font-size: 14px; font-weight: 700; color: var(--brand-gold); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .chart-main { grid-column: span 8; height: 380px; }
        .chart-side { grid-column: span 4; height: 380px; }
        
        /* TABLE SECTIONS */
        .table-section { grid-column: span 8; }
        .crm-section { grid-column: span 4; }

        /* =========================================
           5. DATA TABLES & LISTS
           ========================================= */
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .custom-table th { 
            text-align: left; padding: 12px 15px; 
            color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 700; 
            border-bottom: 2px solid var(--border); 
        }
        .custom-table td { 
            padding: 14px 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            font-size: 13px; color: var(--text-main);
            vertical-align: middle;
        }
        .custom-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Agent Profile in Table */
        .agent-profile { display: flex; align-items: center; gap: 12px; }
        .agent-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        .agent-details div { font-weight: 600; color: white; }
        .agent-details span { font-size: 10px; color: var(--text-muted); }

        /* Progress Bar in Table */
        .goal-wrapper { width: 100%; max-width: 120px; }
        .goal-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 3px; }
        .goal-fill { height: 100%; background: var(--brand-gold); border-radius: 3px; }
        .goal-text { font-size: 10px; color: var(--text-dim); }

        /* CRM List */
        .risk-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .risk-item { 
            background: #252525; padding: 12px 15px; border-radius: 8px; 
            border-left: 3px solid var(--text-muted); 
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .risk-item:hover { transform: translateX(4px); background: #2a2a2a; }
        .risk-item.high { border-left-color: var(--danger); }
        .risk-item.medium { border-left-color: var(--warning); }
        
        .risk-info h4 { margin: 0; font-size: 13px; color: white; }
        .risk-info p { margin: 2px 0 0; font-size: 11px; color: var(--text-muted); }
        
        .risk-stat { text-align: right; }
        .risk-days { font-size: 14px; font-weight: 700; display: block; }
        .risk-lbl { font-size: 9px; text-transform: uppercase; color: var(--text-muted); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }

        /* =========================================
           6. MATRIX CHART CUSTOMIZATION
           ========================================= */
        .matrix-wrapper { position: relative; height: 100%; width: 100%; }
        .quadrant-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                linear-gradient(90deg, transparent 49.8%, #333 50%, transparent 50.2%),
                linear-gradient(0deg, transparent 49.8%, #333 50%, transparent 50.2%);
            z-index: 0;
            pointer-events: none;
        }
        .q-label { position: absolute; font-size: 10px; font-weight: 800; text-transform: uppercase; opacity: 0.3; }
        .ql-1 { top: 10px; right: 10px; color: var(--success); } /* High Vol / High Margin */
        .ql-2 { top: 10px; left: 10px; color: var(--info); }    /* Low Vol / High Margin */
        .ql-3 { bottom: 10px; right: 10px; color: var(--warning); } /* High Vol / Low Margin */
        .ql-4 { bottom: 10px; left: 10px; color: var(--danger); } /* Low Vol / Low Margin */

        /* =========================================
           7. MODALS
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal {
            background: var(--bg-panel); width: 600px; border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: fadeInModal 0.3s ease;
        }
        @keyframes fadeInModal { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
        
        .modal-header {
            padding: 20px 25px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-family: 'Montserrat'; font-size: 16px; font-weight: 700; color: white; }
        .modal-body { padding: 25px; }
        .modal-footer {
            padding: 20px 25px; border-top: 1px solid var(--border);
            display: flex; justify-content: flex-end; gap: 10px;
        }

        .frm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .frm-group { margin-bottom: 15px; }
        .frm-label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        .frm-control {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            padding: 10px 12px; border-radius: 6px; color: white; font-family: 'Open Sans';
            transition: 0.2s;
        }
        .frm-control:focus { border-color: var(--brand-gold); background: #303030; }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand-area">
            <div class="brand-logo-circle">M</div>
            <div class="brand-text">
                <h2>CASA MASSIMA</h2>
                <span>Enterprise ERP</span>
            </div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="https://renato0503.github.io/CasaM_Menu/" class="nav-link">
                    <i class="fa fa-truck-fast"></i> Simulador Logístico
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/CasaM_PerformanceComercial/" class="nav-link active">
                    <i class="fa fa-chart-line"></i> Performance Comercial
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/CasaM_EquipeVendas/" class="nav-link">
                    <i class="fa fa-users"></i> Equipe de Vendas
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/CasaM_Comissoes/" class="nav-link">
                    <i class="fa fa-file-invoice-dollar"></i> Comissões
                </a>
            </li>
            <li class="nav-item">
                <a href="https://renato0503.github.io/CasaM_RotasZonas/" class="nav-link">
                    <i class="fa fa-map-location-dot"></i> Rotas & Zonas
                </a>
            </li>
        </ul>

        <div class="user-panel">
            <div class="user-avatar">F</div>
            <div style="line-height:1.2">
                <span style="display:block; font-size:13px; font-weight:600; color:white">Fausto</span>
                <span style="font-size:10px; color:var(--text-muted)">Administrador</span>
            </div>
        </div>
    </aside>

    <div class="main-content">
        
        <header class="top-header">
            <div class="page-info">
                <h1>Sales Intelligence</h1>
                <p>Monitoramento de Vendas, Margem Broker e Gestão de Carteira</p>
            </div>
            <div class="header-controls">
                <div class="date-filter">
                    <i class="fa fa-calendar"></i>
                    <span>Fevereiro 2026</span>
                    <i class="fa fa-chevron-down" style="font-size:10px; margin-left:5px"></i>
                </div>
                <button class="btn btn-outline" onclick="exportCSV()"><i class="fa fa-download"></i> Relatório</button>
                <button class="btn btn-primary" onclick="openModal()"><i class="fa fa-plus"></i> Lançar Venda</button>
            </div>
        </header>

        <div class="scrollable-content">
            
            <div class="dashboard-grid">
                
                <div class="kpi-card" style="border-top: 3px solid var(--info);">
                    <i class="fa fa-sack-dollar kpi-icon-bg"></i>
                    <div class="kpi-header">
                        <span class="kpi-title">Faturamento Broker (Mês)</span>
                        <span class="kpi-badge bg-success-dim">+12.4%</span>
                    </div>
                    <span class="kpi-value" id="kpiRevenue">R$ 0,00</span>
                    <span class="kpi-subtext">Meta: R$ 500k <span style="color:var(--text-muted)">| 85% Atingido</span></span>
                </div>

                <div class="kpi-card" style="border-top: 3px solid var(--success);">
                    <i class="fa fa-chart-pie kpi-icon-bg"></i>
                    <div class="kpi-header">
                        <span class="kpi-title">Margem Líquida Real</span>
                        <span class="kpi-badge bg-success-dim">+2.1%</span>
                    </div>
                    <span class="kpi-value" id="kpiMargin" style="color:var(--success)">R$ 0,00</span>
                    <span class="kpi-subtext">Média: <span id="kpiMarginPerc">0%</span> (Ref. Indústria)</span>
                </div>

                <div class="kpi-card" style="border-top: 3px solid var(--brand-gold);">
                    <i class="fa fa-truck-ramp-box kpi-icon-bg"></i>
                    <div class="kpi-header">
                        <span class="kpi-title">Volume Expedido</span>
                        <span class="kpi-badge bg-danger-dim">-1.5%</span>
                    </div>
                    <span class="kpi-value" id="kpiVolume">0 Ton</span>
                    <span class="kpi-subtext">Previsão: 55 Ton até dia 30</span>
                </div>

                <div class="kpi-card" style="border-top: 3px solid var(--danger);">
                    <i class="fa fa-user-xmark kpi-icon-bg"></i>
                    <div class="kpi-header">
                        <span class="kpi-title">Risco de Churn</span>
                        <span class="kpi-badge bg-danger-dim">Crítico</span>
                    </div>
                    <span class="kpi-value" id="kpiChurn" style="color:var(--danger)">0</span>
                    <span class="kpi-subtext">Clientes sem compra > 45 dias</span>
                </div>

                <div class="panel chart-main">
                    <div class="panel-header">
                        <span class="panel-title">Evolução de Vendas vs. Margem</span>
                        <div style="display:flex; gap:10px">
                            <button class="btn btn-outline" style="padding:5px 10px; font-size:10px">Semanal</button>
                            <button class="btn btn-gold" style="padding:5px 10px; font-size:10px">Mensal</button>
                        </div>
                    </div>
                    <div style="height: 100%; width: 100%;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="panel chart-side">
                    <div class="panel-header">
                        <span class="panel-title">Matriz de Eficiência</span>
                        <i class="fa fa-circle-info" style="color:#666; cursor:help" title="Bolhas = Vendedores. Eixo X = Venda, Eixo Y = Margem, Tamanho = Volume"></i>
                    </div>
                    <div class="matrix-wrapper">
                        <div class="quadrant-bg"></div>
                        <span class="q-label ql-1">Estrelas</span>
                        <span class="q-label ql-2">Oportunidade</span>
                        <span class="q-label ql-3">Venda "Burra"</span>
                        <span class="q-label ql-4">Problema</span>
                        <canvas id="matrixChart"></canvas>
                    </div>
                </div>

                <div class="panel table-section">
                    <div class="panel-header">
                        <span class="panel-title">Performance por Vendedor</span>
                        <input type="text" placeholder="Filtrar Vendedor..." class="frm-control" style="width:200px; padding:6px 10px; font-size:12px">
                    </div>
                    <div style="overflow-x:auto">
                        <table class="custom-table" id="salesTable">
                            <thead>
                                <tr>
                                    <th>Vendedor / Rota</th>
                                    <th>Volume (Kg)</th>
                                    <th>Vendas (R$)</th>
                                    <th>Margem Real</th>
                                    <th>Meta (R$)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel crm-section">
                    <div class="panel-header">
                        <span class="panel-title" style="color:var(--danger)">Alerta de Inatividade</span>
                        <span style="font-size:10px; color:#666">Top 5 Críticos</span>
                    </div>
                    <ul class="risk-list" id="crmList">
                        </ul>
                    <button class="btn btn-outline" style="width:100%; margin-top:15px; justify-content:center">Ver Lista Completa</button>
                </div>

            </div> <footer style="text-align:center; color:#444; font-size:11px; margin-top:20px; padding-bottom:20px">
                &copy; 2026 Casa Massima Intelligence System v5.2 | Cuiabá - MT
            </footer>

        </div>
    </div>

    <div class="modal-overlay" id="saleModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Novo Registro de Venda</span>
                <i class="fa fa-times" style="color:#666; cursor:pointer" onclick="closeModal()"></i>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="frm-grid">
                        <div class="frm-group">
                            <label class="frm-label">Vendedor</label>
                            <select id="mAgent" class="frm-control">
                                </select>
                        </div>
                        <div class="frm-group">
                            <label class="frm-label">Cliente</label>
                            <input type="text" class="frm-control" placeholder="Razão Social...">
                        </div>
                    </div>
                    <div class="frm-grid">
                        <div class="frm-group">
                            <label class="frm-label">Valor Venda (R$)</label>
                            <input type="number" id="mValue" class="frm-control" placeholder="0.00">
                        </div>
                        <div class="frm-group">
                            <label class="frm-label">Custo Logístico (R$)</label>
                            <input type="number" id="mCost" class="frm-control" placeholder="0.00">
                        </div>
                    </div>
                    <div class="frm-grid">
                        <div class="frm-group">
                            <label class="frm-label">Peso (Kg)</label>
                            <input type="number" id="mKg" class="frm-control" placeholder="0">
                        </div>
                        <div class="frm-group">
                            <label class="frm-label">Data</label>
                            <input type="date" class="frm-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addSale()">Salvar Registro</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const fmtMoney = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const fmtNum = new Intl.NumberFormat('pt-BR');
        
        let agents = [
            { id: 1, name: 'Carlos Silva', route: 'Sinop (Norte)', img: 'https://i.pravatar.cc/150?u=1', sales: 154000, cost: 128000, kg: 8500, goal: 160000 },
            { id: 2, name: 'Ana Pereira', route: 'Várzea Grande', img: 'https://i.pravatar.cc/150?u=2', sales: 82000, cost: 78000, kg: 3200, goal: 90000 },
            { id: 3, name: 'Roberto Dias', route: 'Lucas R. Verde', img: 'https://i.pravatar.cc/150?u=3', sales: 210000, cost: 165000, kg: 12000, goal: 200000 },
            { id: 4, name: 'Fernanda Lima', route: 'Rondonópolis', img: 'https://i.pravatar.cc/150?u=4', sales: 98000, cost: 82000, kg: 4500, goal: 110000 },
            { id: 5, name: 'João Souza', route: 'Matriz/Balcão', img: 'https://i.pravatar.cc/150?u=5', sales: 45000, cost: 30000, kg: 2000, goal: 50000 }
        ];

        let churnData = [
            { client: 'Padaria Pão Dourado', agent: 'Carlos Silva', days: 48, value: 5000 },
            { client: 'Mercado Central', agent: 'Roberto Dias', days: 35, value: 12000 },
            { client: 'Hotel Mato Grosso', agent: 'Ana Pereira', days: 62, value: 2500 },
            { client: 'Confeitaria Doce Vida', agent: 'Carlos Silva', days: 29, value: 8000 }
        ];

        let trendChart, matrixChart;

        // --- INIT ---
        window.onload = () => {
            renderDashboard();
            initCharts();
            populateAgentSelect();
        };

        // --- RENDER LOGIC ---
        function renderDashboard() {
            // 1. Calculate Totals
            let totalRev = 0, totalCost = 0, totalKg = 0;
            agents.forEach(a => {
                totalRev += a.sales;
                totalCost += a.cost;
                totalKg += a.kg;
            });
            let totalMargin = totalRev - totalCost;
            let marginPerc = (totalMargin / totalRev) * 100;

            // 2. Update KPI Cards
            document.getElementById('kpiRevenue').innerText = fmtMoney.format(totalRev);
            document.getElementById('kpiMargin').innerText = fmtMoney.format(totalMargin);
            document.getElementById('kpiMarginPerc').innerText = marginPerc.toFixed(1) + '%';
            document.getElementById('kpiVolume').innerText = (totalKg/1000).toFixed(1) + ' Ton';
            
            const highRisk = churnData.filter(c => c.days > 45).length;
            document.getElementById('kpiChurn').innerText = highRisk;

            // 3. Render Table
            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = '';
            
            // Sort by Sales desc
            let sortedAgents = [...agents].sort((a,b) => b.sales - a.sales);

            sortedAgents.forEach(a => {
                const margin = a.sales - a.cost;
                const percent = (a.sales / a.goal) * 100;
                let statusColor = '#3b82f6'; 
                if(percent >= 100) statusColor = '#10b981';
                if(percent < 70) statusColor = '#ef4444';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="agent-profile">
                            <img src="${a.img}" class="agent-img">
                            <div class="agent-details">
                                <div>${a.name}</div>
                                <span>${a.route}</span>
                            </div>
                        </div>
                    </td>
                    <td>${fmtNum.format(a.kg)}</td>
                    <td style="font-weight:bold">${fmtMoney.format(a.sales)}</td>
                    <td style="color:${margin>0 ? 'var(--success)':'var(--danger)'}">${fmtMoney.format(margin)}</td>
                    <td>
                        <div class="goal-wrapper">
                            <div class="goal-bar-bg"><div class="goal-fill" style="width:${Math.min(percent,100)}%; background:${statusColor}"></div></div>
                            <div class="goal-text">${fmtMoney.format(a.goal)} (${percent.toFixed(0)}%)</div>
                        </div>
                    </td>
                    <td>
                         ${percent >= 100 ? '<span class="status-badge" style="background:rgba(16,185,129,0.2); color:#10b981; padding:3px 8px; border-radius:4px; font-size:10px">Meta Batida</span>' : '<span style="font-size:10px; color:#666">Em andamento</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 4. Render CRM List
            const crmList = document.getElementById('crmList');
            crmList.innerHTML = '';
            
            // Sort risk descending
            churnData.sort((a,b) => b.days - a.days).forEach(c => {
                const riskLevel = c.days > 45 ? 'high' : 'medium';
                const colorClass = c.days > 45 ? 'text-danger' : 'text-warning';
                
                crmList.innerHTML += `
                    <li class="risk-item ${riskLevel}">
                        <div class="risk-info">
                            <h4>${c.client}</h4>
                            <p>${c.agent} • Recorrência: ${fmtMoney.format(c.value)}</p>
                        </div>
                        <div class="risk-stat">
                            <span class="risk-days ${colorClass}">${c.days} dias</span>
                            <span class="risk-lbl">sem pedido</span>
                        </div>
                    </li>
                `;
            });
        }

        // --- CHARTS ---
        function initCharts() {
            // Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    datasets: [
                        { label: 'Vendas', data: [85000, 92000, 88000, 105000], borderColor: '#d4a373', tension: 0.4 },
                        { label: 'Custo', data: [68000, 72000, 70000, 81000], borderColor: '#333', borderDash: [5,5], tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#999' } } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#666' } },
                        x: { grid: { display:false }, ticks: { color: '#666' } }
                    }
                }
            });

            // Matrix Chart
            const ctxMatrix = document.getElementById('matrixChart').getContext('2d');
            updateMatrixData(ctxMatrix);
        }

        function updateMatrixData(ctx) {
            const dataPoints = agents.map(a => {
                const marginPerc = ((a.sales - a.cost) / a.sales) * 100;
                return { x: a.sales, y: marginPerc, r: (a.kg/1000) + 5, agent: a.name };
            });

            if(matrixChart) matrixChart.destroy();

            matrixChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Vendedores',
                        data: dataPoints,
                        backgroundColor: (c) => {
                            const v = c.raw;
                            if(v.y > 15 && v.x > 100000) return '#10b981'; // Star (Green)
                            if(v.y < 5) return '#ef4444'; // Problem (Red)
                            if(v.x < 100000 && v.y > 15) return '#3b82f6'; // Opportunity (Blue)
                            return '#f59e0b'; // Volume/Low Margin (Orange)
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.raw.agent}: ${c.raw.y.toFixed(1)}% Mg` } } },
                    scales: {
                        x: { title: { display: true, text: 'Volume Vendas (R$)', color: '#666' }, grid: { color: '#333' }, ticks: { color: '#666' } },
                        y: { title: { display: true, text: 'Margem (%)', color: '#666' }, grid: { color: '#333' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        // --- ACTIONS ---
        function openModal() { document.getElementById('saleModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('saleModal').style.display = 'none'; }
        
        function populateAgentSelect() {
            const sel = document.getElementById('mAgent');
            agents.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.id;
                opt.innerText = a.name;
                sel.appendChild(opt);
            });
        }

        function addSale() {
            const id = parseInt(document.getElementById('mAgent').value);
            const val = parseFloat(document.getElementById('mValue').value);
            const cost = parseFloat(document.getElementById('mCost').value);
            const kg = parseFloat(document.getElementById('mKg').value);

            const agent = agents.find(a => a.id === id);
            if(agent) {
                agent.sales += val;
                agent.cost += cost;
                agent.kg += kg;
                
                // Refresh UI
                renderDashboard();
                updateMatrixData(document.getElementById('matrixChart').getContext('2d'));
                trendChart.data.datasets[0].data[3] += val; // Simulating adding to last week
                trendChart.update();
                
                closeModal();
                alert(`Venda de ${fmtMoney.format(val)} adicionada para ${agent.name}`);
            }
        }

        function exportCSV() {
            let csv = "Vendedor,Rota,Volume(Kg),Vendas,Custo,Margem\n";
            agents.forEach(a => {
                csv += `${a.name},${a.route},${a.kg},${a.sales},${a.cost},${a.sales-a.cost}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'performance_comercial.csv';
            a.click();
        }

    </script>
</body>
</html>